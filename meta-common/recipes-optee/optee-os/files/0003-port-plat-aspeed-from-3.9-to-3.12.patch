From cafaaad89c7505e06e291108cc5e70452b0e05fc Mon Sep 17 00:00:00 2001
From: Zhikui Ren <zhikui.ren@intel.com>
Date: Thu, 29 Apr 2021 17:42:25 -0700
Subject: [PATCH 2/2] plat-aspeed: port from 3.9 to 3.12

Signed-off-by: Zhikui Ren <zhikui.ren@intel.com>
---
 core/arch/arm/plat-aspeed/main.c | 29 +----------------------------
 core/arch/arm/plat-aspeed/psci.c |  5 ++---
 2 files changed, 3 insertions(+), 31 deletions(-)

diff --git a/core/arch/arm/plat-aspeed/main.c b/core/arch/arm/plat-aspeed/main.c
index 4cd8429f..ed752996 100644
--- a/core/arch/arm/plat-aspeed/main.c
+++ b/core/arch/arm/plat-aspeed/main.c
@@ -2,14 +2,10 @@
 #include <drivers/gic.h>
 #include <drivers/ns16550.h>
 #include <io.h>
-#include <kernel/generic_boot.h>
 #include <kernel/panic.h>
-#include <kernel/pm_stubs.h>
 #include <mm/core_memprot.h>
 #include <platform_config.h>
 #include <stdint.h>
-#include <tee/entry_std.h>
-#include <tee/entry_fast.h>
 
 static struct ns16550_data console_data __nex_bss;
 
@@ -18,24 +14,6 @@ register_phys_mem(MEM_AREA_IO_NSEC, CONSOLE_UART_BASE, 0x1000);
  *register_phys_mem_pgdir(MEM_AREA_IO_NSEC, ISRAM_BASE, ISRAM_SIZE);
  */
 
-static const struct thread_handlers handlers = {
-#if defined(CFG_WITH_ARM_TRUSTED_FW)
-	.cpu_on = cpu_on_handler,
-	.cpu_off = pm_do_nothing,
-	.cpu_suspend = pm_do_nothing,
-	.cpu_resume = pm_do_nothing,
-	.system_off = pm_do_nothing,
-	.system_reset = pm_do_nothing,
-#else
-	.cpu_on = pm_panic,
-	.cpu_off = pm_panic,
-	.cpu_suspend = pm_panic,
-	.cpu_resume = pm_panic,
-	.system_off = pm_panic,
-	.system_reset = pm_panic,
-#endif
-};
-
 #define GIC_BASE		0x40461000
 #define GICC_OFFSET		0x1000
 #define GICD_OFFSET		0x0
@@ -76,14 +54,9 @@ void itr_core_handler(void)
 
 #endif
 
-const struct thread_handlers *generic_boot_get_handlers(void)
-{
-	return &handlers;
-}
-
 void console_init(void)
 {
-	ns16550_init(&console_data, CONSOLE_UART_BASE);
+	ns16550_init(&console_data, CONSOLE_UART_BASE, IO_WIDTH_U32, 0);
 	register_serial_console(&console_data.chip);
 	DMSG("Early console on UART");
 }
diff --git a/core/arch/arm/plat-aspeed/psci.c b/core/arch/arm/plat-aspeed/psci.c
index 1c7be1be..831656a1 100644
--- a/core/arch/arm/plat-aspeed/psci.c
+++ b/core/arch/arm/plat-aspeed/psci.c
@@ -4,10 +4,9 @@
 
 #include <console.h>
 #include <io.h>
-#include <kernel/generic_boot.h>
+#include <kernel/boot.h>
 #include <kernel/misc.h>
 #include <kernel/panic.h>
-#include <kernel/pm_stubs.h>
 #include <mm/core_mmu.h>
 #include <mm/core_memprot.h>
 #include <platform_config.h>
@@ -71,7 +70,7 @@ int psci_cpu_on(uint32_t core_idx, uint32_t entry,
 		return PSCI_RET_INVALID_PARAMETERS;
 
 	/* set secondary core's NS entry addresses */
-	generic_boot_set_core_ns_entry(pos, entry, context_id);
+	boot_set_core_ns_entry(pos, entry, context_id);
 
 	ast2600_prepare_cpus();
 	val = virt_to_phys((void *)TEE_TEXT_VA_START);
-- 
2.17.1


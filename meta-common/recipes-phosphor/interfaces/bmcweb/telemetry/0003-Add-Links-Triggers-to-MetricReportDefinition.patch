From 5229cc158ec5a5777427a55c275ffb0b40546f2b Mon Sep 17 00:00:00 2001
From: Szymon Dompke <szymon.dompke@intel.com>
Date: Mon, 7 Mar 2022 14:28:06 +0100
Subject: [PATCH] Add Links/Triggers to MetricReportDefinition

This change is adding Triggers property to Links when GET is called on
MetricReportDefinition. It contains array of @odata.id pointing to
Trigger resource if it is also linking to given MRD.

Testing done:
- Links/Trigger property is returned by GET request on
  /redfish/v1/TelemetryService/MetricReportDefinitions/<str>/

Signed-off-by: Szymon Dompke <szymon.dompke@intel.com>
Change-Id: I5accf4b50324437b0b185003200078ad2c7020b0
---
 include/dbus_utility.hpp                      |  1 +
 redfish-core/lib/metric_report_definition.hpp | 45 ++++++++++++++++++-
 2 files changed, 45 insertions(+), 1 deletion(-)

diff --git a/include/dbus_utility.hpp b/include/dbus_utility.hpp
index ee9aaab8..c863c30f 100644
--- a/include/dbus_utility.hpp
+++ b/include/dbus_utility.hpp
@@ -67,6 +67,7 @@ using DbusVariantType = std::variant<
     std::vector<uint16_t>,
     sdbusplus::message::object_path,
     std::tuple<uint64_t, std::vector<std::tuple<std::string, double, uint64_t>>>,
+    std::vector<sdbusplus::message::object_path>,
     std::vector<std::tuple<std::string, std::string>>,
     std::vector<std::tuple<uint32_t, std::vector<uint32_t>>>,
     std::vector<std::tuple<uint32_t, size_t>>,
diff --git a/redfish-core/lib/metric_report_definition.hpp b/redfish-core/lib/metric_report_definition.hpp
index 4f1159ad..dfbc3a22 100644
--- a/redfish-core/lib/metric_report_definition.hpp
+++ b/redfish-core/lib/metric_report_definition.hpp
@@ -170,6 +170,38 @@ inline std::string toDbusReportUpdates(std::string_view redfishValue)
     return "";
 }
 
+inline std::optional<nlohmann::json> getLinkedTriggers(
+    std::span<const sdbusplus::message::object_path> triggerPaths)
+{
+    nlohmann::json triggers = nlohmann::json::array();
+
+    for (const sdbusplus::message::object_path& path : triggerPaths)
+    {
+        if (path.parent_path() !=
+            "/xyz/openbmc_project/Telemetry/Triggers/TelemetryService")
+        {
+            BMCWEB_LOG_ERROR << "Property Triggers contains invalid value: "
+                             << path.str;
+            return std::nullopt;
+        }
+
+        std::string id = path.filename();
+        if (id.empty())
+        {
+            BMCWEB_LOG_ERROR << "Property Triggers contains invalid value: "
+                             << path.str;
+            return std::nullopt;
+        }
+
+        triggers.push_back({
+            {"@odata.id", boost::urls::format(
+                              "/redfish/v1/TelemetryService/Triggers/{}", id)},
+        });
+    }
+
+    return std::make_optional(triggers);
+}
+
 inline void
     fillReportDefinition(const std::shared_ptr<bmcweb::AsyncResp>& asyncResp,
                          const std::string& id,
@@ -183,12 +215,14 @@ inline void
     uint64_t appendLimit = 0;
     uint64_t interval = 0;
     bool enabled = false;
+    std::vector<sdbusplus::message::object_path> triggers;
 
     const bool success = sdbusplus::unpackPropertiesNoThrow(
         dbus_utils::UnpackErrorPrinter(), properties, "ReportingType",
         reportingType, "Interval", interval, "ReportActions", reportActions,
         "ReportUpdates", reportUpdates, "AppendLimit", appendLimit,
-        "ReadingParameters", readingParams, "Name", name, "Enabled", enabled);
+        "ReadingParameters", readingParams, "Name", name, "Enabled", enabled,
+        "Triggers", triggers);
 
     if (!success)
     {
@@ -206,6 +240,15 @@ inline void
     asyncResp->res.jsonValue["MetricReportDefinitionType"] =
         redfishReportingType;
 
+    std::optional<nlohmann::json> linkedTriggers = getLinkedTriggers(triggers);
+    if (!linkedTriggers)
+    {
+        messages::internalError(asyncResp->res);
+        return;
+    }
+
+    asyncResp->res.jsonValue["Links"]["Triggers"] = *linkedTriggers;
+
     nlohmann::json::array_t redfishReportActions;
     for (const std::string& action : reportActions)
     {
-- 
2.25.1

